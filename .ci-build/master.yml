job:
  name: insurance-premium-simulation-backend-master
  vm-template: dx-developer
  auto:
    branch: master
  params:
  - password:
      name: ORACLE_SSO_USERNAME
      password: "#{ORACLE_SSO_USERNAME}"
  - password:
      name: ORACLE_SSO_PASSWORD
      password: "#{ORACLE_SSO_PASSWORD}"
  - string:
      name: ORACLE_IMAGE
      value: java/jdk:11.0.8
  - password:
      name: OCIR_USERNAME
      password: "#{OCIR_USERNAME}"
  - password:
      name: OCIR_AUTHTOKEN
      password: "#{OCIR_AUTHTOKEN}"
  - string:
      name: OCIR_IMAGE
      value: oneteam/insurance-premium-simulation-backend
  steps:
   - shell:
       script: |-
         ./mvnw dependency:purge-local-repository -DreResolve=false -f insurance-premium-simulation-backend-parent/pom.xml

         docker logout container-registry.oracle.com
         docker logout nrt.ocir.io

         docker image prune --all --force
   - shell:
       script: ./mvnw clean package -f insurance-premium-simulation-backend-parent/pom.xml
   - shell:
       script: |-
         docker login --username ${ORACLE_SSO_USERNAME} --password ${ORACLE_SSO_PASSWORD} container-registry.oracle.com
         docker pull container-registry.oracle.com/${ORACLE_IMAGE}
         docker logout container-registry.oracle.com
   - shell:
       script: |-
         export TAG=$(git rev-parse --short HEAD)

         docker build -t nrt.ocir.io/nrw7mnqnx9dw/${OCIR_IMAGE}:${TAG} insurance-premium-simulation-backend-spring
   - shell:
       script: |-
         export TAG=$(git rev-parse --short HEAD)

         docker login nrt.ocir.io --username ${OCIR_USERNAME} --password ${OCIR_AUTHTOKEN}
         docker push nrt.ocir.io/nrw7mnqnx9dw/${OCIR_IMAGE}:${TAG}
         docker logout nrt.ocir.io

         docker image prune --all --force
  settings:
  - versions:
      version-map:
        java: 11
